<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æ¯æ—¥å­¦ä¹ ä»»åŠ¡ï¼ˆåˆ†ç±»åŒæ­¥ç‰ˆï¼Œè‡ªåŠ¨è·å–æ ‡é¢˜å’Œæ’­æ”¾åˆ—è¡¨ï¼‰</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 20px;
      background-color: #f9f9f9;
    }
    .category-section { margin-bottom: 40px; }
    .category-title { font-size: 1.5em; margin-bottom: 10px; }
    .video-container {
      margin: 20px auto;
      max-width: 720px;
      border: 1px solid #ddd;
      padding: 10px;
      background-color: #fff;
    }
    iframe {
      width: 100%;
      height: 400px;
      border: none;
    }
    .video-title {
      font-size: 1.2em;
      margin: 10px 0;
    }
    .complete-btn {
      margin-top: 10px;
      padding: 8px 16px;
      font-size: 1em;
      cursor: pointer;
    }
    .note {
      margin-top: 20px;
      font-size: 1.1em;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>ğŸ“… ä»Šæ—¥å­¦ä¹ ä»»åŠ¡</h1>
  <div id="taskContainer"></div>
  <div class="note" id="globalNote"></div>
  
  <script>
    // ================= é…ç½®åŒº =================
    // GitHub é…ç½®ï¼ˆç”¨äºè¿œç¨‹åŒæ­¥è§‚çœ‹è®°å½•ï¼‰
    const GITHUB_TOKEN = "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";
    const GIST_ID = "5219c79ef0aec738178117462bb83dee#file-completedtasks-json";
    // YouTube Data API Keyï¼ˆä½¿ç”¨æ’­æ”¾åˆ—è¡¨åŠŸèƒ½å¿…é¡»æä¾›ï¼Œå¦åˆ™ç•™ç©ºï¼‰
    const YOUTUBE_API_KEY = "AIzaSyBpk7qrH2v2As_h6-yqRcdpM7bE7-UwGWg"; 

    // ================= è§†é¢‘åˆ†ç±»æ•°æ® =================
    // æ¯ä¸ªç±»åˆ«ä¸‹ï¼Œåªéœ€å¡«å†™è§†é¢‘é“¾æ¥ï¼Œå¯ä¸ºåµŒå…¥æ ¼å¼çš„å•ä¸ªè§†é¢‘é“¾æ¥æˆ–æ’­æ”¾åˆ—è¡¨é“¾æ¥ï¼ˆå« "list=" å‚æ•°ï¼‰ã€‚
    const videoCategories = {
      "stem": [
        "https://www.youtube.com/embed/FVRwP3FmUeI?rel=0&loop=1&modestbranding=1&cc_load_policy=1&hl=zh-CN",
        "https://www.youtube.com/embed/cf-JUz3gqdk?rel=0&loop=1&modestbranding=1&cc_load_policy=1&hl=zh-CN",
        "https://www.youtube.com/playlist?list=PLw2cuKNQvZ2eib4vBY4qHgxYlxUydaEAV"
      ],
      "è‰ºæœ¯": [
        "https://www.youtube.com/embed/UhB0U6OUPIM?rel=0&loop=1&modestbranding=1&cc_load_policy=1&hl=zh-CN",
      ]
      // è‹¥æœ‰å…¶ä»–ç±»åˆ«ï¼Œå¯ä»¥åœ¨æ­¤æ·»åŠ ï¼Œå¦‚ "è¯­è¨€"ã€"å†å²" ç­‰
    };

    // ================= æ’ç¨‹å‚æ•° =================
    // é’ˆå¯¹æ¯ä¸ªç±»åˆ«è®¾ç½®èµ·å§‹æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰ä»¥åŠæ¯å¤©å±•ç¤ºçš„è§†é¢‘æ•°é‡
    const scheduleConfig = {
      "stem": {
        startDate: "2025-04-13",
        videosPerDay: 2
      },
      "è‰ºæœ¯": {
        startDate: "2025-04-13",
        videosPerDay: 1
      }
      // æ–°å¢ç±»åˆ«æ—¶ï¼Œè¯·åœ¨æ­¤æ·»åŠ ç›¸åº”é…ç½®
    };

    // ================= è¾…åŠ©å‡½æ•° =================
    // è·å–ä»Šå¤©æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆæ ¼å¼ YYYY-MM-DDï¼‰
    function getTodayStr() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    // è®¡ç®—ä¸¤ä¸ªæ—¥æœŸå­—ç¬¦ä¸²ç›¸å·®çš„å¤©æ•°
    function dateDiff(startDateStr, endDateStr) {
      const start = new Date(startDateStr);
      const end = new Date(endDateStr);
      const diffTime = end - start;
      return Math.floor(diffTime / (1000 * 60 * 60 * 24));
    }

    // ================= GitHub Gist è¿œç¨‹å­˜å‚¨ =================
    async function loadRemoteCompleted() {
      try {
        const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
          headers: { "Authorization": `token ${GITHUB_TOKEN}` }
        });
        const gistData = await response.json();
        if (gistData.files && gistData.files["completedTasks.json"]) {
          const content = gistData.files["completedTasks.json"].content;
          return JSON.parse(content || "{}");
        }
      } catch (error) {
        console.error("åŠ è½½è¿œç¨‹è®°å½•å¤±è´¥ï¼š", error);
      }
      return {};
    }

    async function setRemoteCompleted(completed) {
      try {
        await fetch(`https://api.github.com/gists/${GIST_ID}`, {
          method: "PATCH",
          headers: {
            "Authorization": `token ${GITHUB_TOKEN}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            files: { "completedTasks.json": { content: JSON.stringify(completed) } }
          })
        });
      } catch (error) {
        console.error("æ›´æ–°è¿œç¨‹è®°å½•å¤±è´¥ï¼š", error);
      }
    }

    // ================= è‡ªåŠ¨è·å–è§†é¢‘æ ‡é¢˜ï¼ˆé€šè¿‡ oEmbedï¼‰ =================
    async function getVideoTitle(embedUrl) {
      // å°† embed URL è½¬æ¢ä¸ºå¸¸è§„è§†é¢‘é“¾æ¥ï¼ˆ"/embed/" æ›¿æ¢ä¸º "/watch?v="ï¼‰
      const watchUrl = embedUrl.replace('/embed/', '/watch?v=');
      const oembedUrl = `https://www.youtube.com/oembed?url=${encodeURIComponent(watchUrl)}&format=json`;
      try {
        const response = await fetch(oembedUrl);
        if (response.ok) {
          const data = await response.json();
          return data.title;
        }
      } catch (e) {
        console.error("è·å–è§†é¢‘æ ‡é¢˜å¤±è´¥ï¼š", e);
      }
      return "æœªçŸ¥è§†é¢‘";
    }

    // ================= æ’­æ”¾åˆ—è¡¨å¤„ç† =================
    // é’ˆå¯¹æ’­æ”¾åˆ—è¡¨é“¾æ¥ï¼Œè°ƒç”¨ YouTube Data API è·å–è§†é¢‘æ•°æ®ï¼ˆæœ€å¤šè¿”å›50ä¸ªè§†é¢‘ï¼Œè‹¥åˆ—è¡¨è¾ƒé•¿å¯æ‰©å±•ï¼‰
    async function fetchPlaylistVideos(playlistUrl) {
      let playlistId = "";
      const urlObj = new URL(playlistUrl);
      if (urlObj.searchParams.has("list")) {
        playlistId = urlObj.searchParams.get("list");
      }
      if (!playlistId) return [];
      if (!YOUTUBE_API_KEY) {
        console.error("ä½¿ç”¨æ’­æ”¾åˆ—è¡¨åŠŸèƒ½éœ€è¦æä¾› YouTube API Key");
        return [];
      }
      const apiEndpoint = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${playlistId}&key=${YOUTUBE_API_KEY}`;
      try {
        const response = await fetch(apiEndpoint);
        const data = await response.json();
        if (data.items) {
          return data.items.map(item => {
            const videoId = item.snippet.resourceId.videoId;
            return { url: `https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1&cc_load_policy=1&hl=zh-CN` };
          });
        }
      } catch (error) {
        console.error("è·å–æ’­æ”¾åˆ—è¡¨è§†é¢‘å¤±è´¥ï¼š", error);
      }
      return [];
    }

    // ================= å¤„ç†æ¯ä¸ªåˆ†ç±»çš„é“¾æ¥ =================
    // å°† videoCategories ä¸­çš„æ¯ä¸ªé“¾æ¥å¤„ç†ä¸ºå•ä¸ªè§†é¢‘å¯¹è±¡æ•°ç»„ï¼ˆæ£€æµ‹é“¾æ¥ä¸­æ˜¯å¦åŒ…å«æ’­æ”¾åˆ—è¡¨å‚æ•°ï¼‰
    async function processCategory(category) {
      const links = videoCategories[category];
      let videos = [];
      for (let link of links) {
        if (link.indexOf("list=") !== -1) {
          const listVideos = await fetchPlaylistVideos(link);
          videos = videos.concat(listVideos);
        } else {
          videos.push({ url: link });
        }
      }
      return videos;
    }

    // ================= ä»»åŠ¡è°ƒåº¦ä¸åŠ è½½ =================
    async function loadTasks() {
      const todayStr = getTodayStr();
      const completed = await loadRemoteCompleted();
      const taskList = [];
      const categoryVideos = {};
      const categoryPromises = Object.keys(videoCategories).map(async category => {
        categoryVideos[category] = await processCategory(category);
      });
      await Promise.all(categoryPromises);
      
      // æ ¹æ®æ’ç¨‹é…ç½®ï¼Œæ¯ä¸ªç±»åˆ«åº”å±•ç¤ºçš„è§†é¢‘æ•°é‡è®¡ç®—
      Object.keys(categoryVideos).forEach(category => {
        const config = scheduleConfig[category];
        if (!config) return;
        let daysPassed = dateDiff(config.startDate, todayStr);
        if (daysPassed < 0) daysPassed = 0;
        const numVideosExpected = (daysPassed + 1) * config.videosPerDay;
        const videos = categoryVideos[category].slice(0, numVideosExpected);
        videos.forEach(video => {
          // ä»¥â€œç±»åˆ«|è§†é¢‘é“¾æ¥â€ä½œä¸ºå¤åˆ key åˆ¤æ–­æ˜¯å¦å·²å®Œæˆ
          const key = category + "|" + video.url;
          if (!completed[key]) {
            taskList.push({ category: category, url: video.url, scheduleDate: config.startDate });
          }
        });
      });
      renderTasks(taskList);
    }

    // ================= æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ =================
    function renderTasks(taskList) {
      const container = document.getElementById("taskContainer");
      container.innerHTML = "";
      if (taskList.length === 0) {
        document.getElementById("globalNote").innerText = "æ‰€æœ‰ä»»åŠ¡å‡å·²å®Œæˆï¼";
        return;
      }
      document.getElementById("globalNote").innerText = "è¯·å®Œæˆä¸‹åˆ—è§†é¢‘ä»»åŠ¡ï¼š";

      // æŒ‰ç±»åˆ«åˆ†ç»„æ˜¾ç¤ºä»»åŠ¡
      const tasksByCategory = {};
      taskList.forEach(task => {
        if (!tasksByCategory[task.category]) {
          tasksByCategory[task.category] = [];
        }
        tasksByCategory[task.category].push(task);
      });
      Object.keys(tasksByCategory).forEach(category => {
        const section = document.createElement("div");
        section.className = "category-section";
        const catTitle = document.createElement("div");
        catTitle.className = "category-title";
        catTitle.innerText = category.toUpperCase();
        section.appendChild(catTitle);

        tasksByCategory[category].forEach(task => {
          const containerDiv = document.createElement("div");
          containerDiv.className = "video-container";
          
          // è§†é¢‘æ ‡é¢˜åŒºåŸŸï¼Œåˆå§‹æ˜¾ç¤ºâ€œåŠ è½½ä¸­â€¦â€ï¼Œåç»­é€šè¿‡ oEmbed å¼‚æ­¥è·å–è§†é¢‘æ ‡é¢˜
          const titleEl = document.createElement("div");
          titleEl.className = "video-title";
          titleEl.innerText = "åŠ è½½ä¸­â€¦";
          containerDiv.appendChild(titleEl);
          getVideoTitle(task.url).then(title => {
            titleEl.innerText = title;
          });
          
          // åµŒå…¥è§†é¢‘ iframeï¼Œæ·»åŠ  allowfullscreen å±æ€§ï¼Œå¹¶é€šè¿‡ URL å‚æ•°æ§åˆ¶æ¨èï¼ˆrel=0 & modestbranding=1ï¼‰
          const iframe = document.createElement("iframe");
          iframe.src = task.url;
          iframe.setAttribute("allowfullscreen", "");
          containerDiv.appendChild(iframe);
          
          // å®ŒæˆæŒ‰é’®
          const btn = document.createElement("button");
          btn.className = "complete-btn";
          btn.innerText = "æˆ‘å·²å®Œæˆ";
          btn.onclick = async function() {
            const completed = await loadRemoteCompleted();
            const key = task.category + "|" + task.url;
            completed[key] = true;
            await setRemoteCompleted(completed);
            loadTasks();
          };
          containerDiv.appendChild(btn);
          
          section.appendChild(containerDiv);
        });
        container.appendChild(section);
      });
    }

    // ================= åˆå§‹åŒ–åŠ è½½é¡µé¢ =================
    loadTasks();
  </script>
</body>
</html>
